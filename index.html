<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MediaPipe + Arduino USB Serial - Hand Tracking</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<style>
body {
  margin: 0;
  background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  font-family: 'Arial', sans-serif;
}

.main-wrapper {
  display: flex;
  gap: 15px;
  padding: 15px;
  max-width: 1400px;
  width: 100%;
}

.container {
  position: relative;
  width: 800px;
  height: 600px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

video, canvas {
  position: absolute;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#info {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  padding: 12px 30px;
  font-size: 18px;
  border-radius: 25px;
  background: #f59e0b;
  color: white;
  font-weight: bold;
  z-index: 10;
}

.tracking { background: #22c55e !important; }
.loading { background: #f59e0b !important; }
.no-person { background: #ef4444 !important; }

#hands-status {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 15px;
  z-index: 10;
}

.hand-label {
  padding: 10px 20px;
  border-radius: 8px;
  background: #6b7280;
  color: white;
  font-weight: bold;
  font-size: 14px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.hand-label.on { background: #22c55e; }
.hand-label.off { background: #ef4444; }

/* Right Panel - Control */
.control-panel {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  width: 320px;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.panel-title {
  font-size: 18px;
  font-weight: bold;
  color: #333;
  margin-bottom: 10px;
  border-bottom: 3px solid #3b82f6;
  padding-bottom: 10px;
}

.serial-section {
  background: #f3f4f6;
  padding: 12px;
  border-radius: 8px;
}

.serial-label {
  font-size: 12px;
  color: #666;
  font-weight: bold;
  margin-bottom: 8px;
}

.button-group {
  display: flex;
  gap: 8px;
}

button {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 12px;
}

.btn-connect {
  background: #3b82f6;
  color: white;
}

.btn-connect:hover {
  background: #2563eb;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
}

.btn-connect:disabled {
  background: #9ca3af;
  cursor: not-allowed;
  transform: none;
}

.btn-disconnect {
  background: #ef4444;
  color: white;
}

.btn-disconnect:hover {
  background: #dc2626;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
}

.connection-status {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px;
  background: white;
  border-radius: 6px;
  font-size: 12px;
  color: #666;
}

.status-indicator {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: #ef4444;
}

.status-indicator.connected {
  background: #22c55e;
}

.data-log {
  background: #1f2937;
  color: #10b981;
  padding: 10px;
  border-radius: 6px;
  font-size: 11px;
  font-family: 'Courier New', monospace;
  max-height: 120px;
  overflow-y: auto;
  border: 1px solid #374151;
}

.data-log-title {
  font-weight: bold;
  margin-bottom: 6px;
  color: #60a5fa;
}

.data-item {
  margin: 2px 0;
  color: #10b981;
}

.sent-data {
  color: #fbbf24;
}

.status-info {
  background: #f0f9ff;
  padding: 10px;
  border-radius: 6px;
  border-left: 4px solid #3b82f6;
  font-size: 12px;
  color: #1e40af;
}

.info-item {
  margin: 5px 0;
}

.info-label {
  font-weight: bold;
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: #f0f0f0;
}

::-webkit-scrollbar-thumb {
  background: #3b82f6;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: #2563eb;
}

.data-log::-webkit-scrollbar-track {
  background: #374151;
}

.data-log::-webkit-scrollbar-thumb {
  background: #10b981;
}
</style>
</head>

<body>

<div class="main-wrapper">
  <!-- Left: Video Container -->
  <div class="container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    <div id="info">LOADING...</div>
    <div id="hands-status">
      <div class="hand-label off" id="left-hand">LEFT: OFF</div>
      <div class="hand-label off" id="right-hand">RIGHT: OFF</div>
    </div>
  </div>

  <!-- Right: Control Panel -->
  <div class="control-panel">
    <div class="panel-title">ðŸ”Œ USB Arduino Control</div>
    
    <!-- Serial Connection -->
    <div class="serial-section">
      <div class="serial-label">Serial Connection</div>
      <div class="button-group">
        <button class="btn-connect" id="connectBtn" onclick="connectSerial()">CONNECT</button>
        <button class="btn-disconnect" id="disconnectBtn" onclick="disconnectSerial()" disabled>DISCONNECT</button>
      </div>
      <div class="connection-status" id="connectionStatus" style="margin-top: 10px;">
        <span class="status-indicator"></span>
        <span id="statusText">Not Connected</span>
      </div>
    </div>

    <!-- Status Info -->
    <div class="status-info">
      <div class="info-item">
        <span class="info-label">LEFT HAND:</span> <span id="status-left">OFF</span>
      </div>
      <div class="info-item">
        <span class="info-label">RIGHT HAND:</span> <span id="status-right">OFF</span>
      </div>
      <div class="info-item">
        <span class="info-label">Baud Rate:</span> 9600
      </div>
    </div>

    <!-- Data Log -->
    <div>
      <div class="data-log" id="dataLog">
        <div class="data-log-title">ðŸ“¡ Data Log</div>
        <div class="data-item">Waiting for connection...</div>
      </div>
    </div>
  </div>
</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const info = document.getElementById("info");
const leftHandLabel = document.getElementById("left-hand");
const rightHandLabel = document.getElementById("right-hand");
const dataLog = document.getElementById("dataLog");

canvas.width = 800;
canvas.height = 600;

// Serial Port Variables
let port = null;
let reader = null;
let previousLeftHandUp = null;
let previousRightHandUp = null;

// Connect to Serial Port
async function connectSerial() {
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 9600 });
    
    document.getElementById("connectBtn").disabled = true;
    document.getElementById("disconnectBtn").disabled = false;
    
    const indicator = document.querySelector(".status-indicator");
    indicator.classList.add("connected");
    document.getElementById("statusText").textContent = "Connected âœ“";
    
    addLog("Connected to Arduino!", "#10b981");
    
  } catch (error) {
    addLog("Connection failed: " + error.message, "#ef4444");
    console.error("Connection error:", error);
  }
}

// Disconnect from Serial Port
async function disconnectSerial() {
  try {
    if (port) {
      await port.close();
      port = null;
    }
    
    document.getElementById("connectBtn").disabled = false;
    document.getElementById("disconnectBtn").disabled = true;
    
    const indicator = document.querySelector(".status-indicator");
    indicator.classList.remove("connected");
    document.getElementById("statusText").textContent = "Not Connected";
    
    addLog("Disconnected from Arduino", "#ef4444");
    
  } catch (error) {
    addLog("Disconnection error: " + error.message, "#ef4444");
    console.error("Disconnection error:", error);
  }
}

// Send data to Arduino
async function sendToArduino(data) {
  if (!port) return;
  
  try {
    const writer = port.writable.getWriter();
    await writer.write(new Uint8Array([data]));
    writer.releaseLock();
    
    let message = "";
    switch(data) {
      case 1: message = "LEFT HAND UP"; break;
      case 2: message = "LEFT HAND DOWN"; break;
      case 3: message = "RIGHT HAND UP"; break;
      case 4: message = "RIGHT HAND DOWN"; break;
    }
    
    addLog(`ðŸ“¤ Sent: ${data} (${message})`, "#fbbf24");
  } catch (error) {
    addLog("Send error: " + error.message, "#ef4444");
    console.error("Send error:", error);
  }
}

// Add log entry
function addLog(message, color = "#10b981") {
  const timestamp = new Date().toLocaleTimeString();
  const logEntry = document.createElement("div");
  logEntry.className = "data-item";
  logEntry.style.color = color;
  logEntry.textContent = `[${timestamp}] ${message}`;
  dataLog.appendChild(logEntry);
  dataLog.scrollTop = dataLog.scrollHeight;
  
  // Keep only last 20 entries
  const items = dataLog.querySelectorAll(".data-item");
  if (items.length > 20) {
    items[0].remove();
  }
}

// Initialize MediaPipe
const holistic = new Holistic({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${f}`
});

holistic.setOptions({
  modelComplexity: 1,
  smoothLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

holistic.onResults(results => {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (results.poseLandmarks) {
    info.textContent = "TRACKING";
    info.classList.add("tracking");
    info.classList.remove("no-person");

    drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {
      color: "#00ffcc", lineWidth: 4
    });
    drawLandmarks(ctx, results.poseLandmarks, {
      color: "#ffcc00", lineWidth: 2
    });
  } else {
    info.textContent = "NO PERSON";
    info.classList.remove("tracking");
    info.classList.add("no-person");
  }

  if (results.faceLandmarks) {
    drawConnectors(ctx, results.faceLandmarks, FACEMESH_TESSELATION, {
      color: "#60a5fa", lineWidth: 1
    });
  }

  // LEFT HAND Detection
  if (results.leftHandLandmarks && results.leftHandLandmarks.length > 0) {
    const leftWrist = results.leftHandLandmarks[0];
    const leftMidFinger = results.leftHandLandmarks[9];
    const isLeftHandUp = leftMidFinger.y < leftWrist.y;
    
    leftHandLabel.textContent = isLeftHandUp ? "LEFT: ON" : "LEFT: OFF";
    leftHandLabel.classList.toggle("on", isLeftHandUp);
    leftHandLabel.classList.toggle("off", !isLeftHandUp);
    document.getElementById("status-left").textContent = isLeftHandUp ? "ON âœ“" : "OFF";
    
    // Send data when state changes
    if (previousLeftHandUp !== isLeftHandUp) {
      if (isLeftHandUp) {
        sendToArduino(1); // 1 = LEFT HAND UP
      } else {
        sendToArduino(2); // 2 = LEFT HAND DOWN
      }
      previousLeftHandUp = isLeftHandUp;
    }
    
    drawConnectors(ctx, results.leftHandLandmarks, HAND_CONNECTIONS, {
      color: "#22c55e"
    });
  } else {
    leftHandLabel.textContent = "LEFT: OFF";
    leftHandLabel.classList.remove("on");
    leftHandLabel.classList.add("off");
    document.getElementById("status-left").textContent = "OFF";
    
    if (previousLeftHandUp !== false) {
      sendToArduino(2); // 2 = LEFT HAND DOWN
      previousLeftHandUp = false;
    }
  }

  // RIGHT HAND Detection
  if (results.rightHandLandmarks && results.rightHandLandmarks.length > 0) {
    const rightWrist = results.rightHandLandmarks[0];
    const rightMidFinger = results.rightHandLandmarks[9];
    const isRightHandUp = rightMidFinger.y < rightWrist.y;
    
    rightHandLabel.textContent = isRightHandUp ? "RIGHT: ON" : "RIGHT: OFF";
    rightHandLabel.classList.toggle("on", isRightHandUp);
    rightHandLabel.classList.toggle("off", !isRightHandUp);
    document.getElementById("status-right").textContent = isRightHandUp ? "ON âœ“" : "OFF";
    
    // Send data when state changes
    if (previousRightHandUp !== isRightHandUp) {
      if (isRightHandUp) {
        sendToArduino(3); // 3 = RIGHT HAND UP
      } else {
        sendToArduino(4); // 4 = RIGHT HAND DOWN
      }
      previousRightHandUp = isRightHandUp;
    }
    
    drawConnectors(ctx, results.rightHandLandmarks, HAND_CONNECTIONS, {
      color: "#f97316"
    });
  } else {
    rightHandLabel.textContent = "RIGHT: OFF";
    rightHandLabel.classList.remove("on");
    rightHandLabel.classList.add("off");
    document.getElementById("status-right").textContent = "OFF";
    
    if (previousRightHandUp !== false) {
      sendToArduino(4); // 4 = RIGHT HAND DOWN
      previousRightHandUp = false;
    }
  }
});

const camera = new Camera(video, {
  onFrame: async () => {
    await holistic.send({ image: video });
  },
  width: 800,
  height: 600
});

camera.start();
addLog("MediaPipe initialized", "#60a5fa");
</script>

</body>
</html>
